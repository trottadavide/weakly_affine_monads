\documentclass[a4paper,UKenglish,numberwithinsect,cleveref, autoref, thm-restate]{lipics-v2021}




%\usepackage{natbib}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{float}
\usepackage{amsfonts}
\usepackage{amssymb}
\include{macro_davide}
\usepackage{mathtools}
\usepackage{quiver}

\usepackage{hyperref}
\usepackage{xcolor}
\usepackage[all,2cell]{xy}
\UseAllTwocells
\xyoption{v2}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{tikz}
\usepackage{tikzit}

\usetikzlibrary{shapes}

%\input{sample.tikzstyle}
\usepackage{freetikz}
\usetikzlibrary{decorations.markings,positioning,patterns}
\usetikzlibrary{shadows}
\usepackage{array}

%\usetikzlibrary{automata, positioning, arrows}
\input{stringdiagrams.tikzstyles}
\usepackage{todonotes}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\theoremstyle{plain} %italico
\newtheorem{mytheorem}{Theorem}[section]
\newtheorem{mycorollary}[mytheorem]{Corollary}
\newtheorem{mylemma}[mytheorem]{Lemma}
\newtheorem{myproposition}[mytheorem]{Proposition}


\theoremstyle{definition} %stampatello
\newtheorem{mydefinition}[mytheorem]{Definition}
\newtheorem{myproblem}[mytheorem]{Problem}

\newtheorem{myremark}[mytheorem]{Remark}
\newtheorem{myexample}[mytheorem]{Example}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\stringdiagnabla}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-4.25, 0) {};
		\node [style=none] (1) at (-2.75, 0.5) {};
		\node [style=none] (2) at (-2.75, -0.5) {};
		\node [style=none] (3) at (-2, -0.5) {};
		\node [style=none] (4) at (-2, 0.5) {};
		\node [style=nodonero] (5) at (-3.25, 0) {};
		\node [style=none] (7) at (-3.75, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (5);
		\draw [bend left, looseness=1.25] (5) to (1.center);
		\draw (1.center) to (4.center);
		\draw [bend right] (5) to (2.center);
		\draw (2.center) to (3.center);
	\end{pgfonlayer}
	\pgfsetbaseline{-0.4ex}
\end{tikzpicture}}


\newcommand{\stringdiagbang}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (8) at (2, 0) {};
		\node [style=nodonero] (9) at (3, 0) {};
		\node [style=none] (10) at (2.5, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (8.center) to (9);
	\end{pgfonlayer}
		\pgfsetbaseline{-.4ex}
\end{tikzpicture}}

\newcommand{\stringdiagidentity}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (8) at (2, 0) {};
		\node [style=none] (9) at (3, 0) {};
		\node [style=none] (10) at (2.5, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (8.center) to (9);
	\end{pgfonlayer}
		\pgfsetbaseline{-.4ex}
\end{tikzpicture}}
\newcommand{\stringdiagfreccia}[3]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=box] (5) at (1.75, 0) {#2};
		\node [style=none] (7) at (3, 0) {};
		\node [style=none] (8) at (2.5, 0.25) {#3};
		\node [style=none] (9) at (0.5, 0) {};
		\node [style=none] (10) at (1, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5) to (7);
		\draw (9.center) to (5);
	\end{pgfonlayer}
	\pgfsetbaseline{-.4ex}
\end{tikzpicture}
}
\newcommand{\nodo}{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=nodonero] (0) at (0, 0) {};
	\end{pgfonlayer}
	\pgfsetbaseline{-.4ex}
\end{tikzpicture}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%




\author{Paolo Perrone}{Department of Computer Science, University of Oxford}{paolo.perrone.math@gmail.com}{ }{}
\author{Fabio Gadducci}{Department of Computer Science, University of Pisa, Pisa, IT}{fabio.gadducci@unipi.it}{ https://orcid.org/
0000-0003-0690-3051}{}
\author{ Davide Trotta }{Department of Computer Science, University of Pisa, Pisa, IT}{trottadavide92@gmail.com}{https://orcid.org/0000-0003-4509-594X}{}
\authorrunning{F. Gadducci et alii}
%The research is supported by the MIUR PRIN 2017FTXR "IT-MaTTerS"

\Copyright{Fabio Gadducci and Paolo Perrone and Davide Trotta} 
\ccsdesc[500]{}


\keywords{string diagrams, gs-monoidal categoriess} %TODO mandatory; please add comma-separated list of keywords

\title{Weakly-affine monads}
\titlerunning{Weakly-affine monads}

\begin{document}

\maketitle
\begin{abstract}

\end{abstract}

\section{Introduction}

For context:
\begin{myproposition}
 A monoid $(M,\cdot,1)$ is a group if and only if the associativity square
 \begin{equation}\label{assoc}
  \begin{tikzcd}
   M \times M \times M \ar{d}{\id\times\cdot} \ar{r}{\cdot\times\id} & M\times M \ar{d}{\cdot} \\
   M\times M \ar{r}{\cdot} & M
  \end{tikzcd}
 \end{equation}
 is a pullback.
\end{myproposition}
\begin{proof}
 The square~\eqref{assoc} is a pullback, both of sets and of groups, if and only if given $a,g,h,c\in M$ such that $ag=hc$, there exists a unique $b\in M$ such that $g=bc$ and $h=ab$.
 First, suppose that $g$ is a group. The only possible choice of $b$ is 
 \[
  b = a^{-1}h = gc^{-1},
 \]
 which is unique by uniqueness of inverses. 
 
 Conversely, suppose that \eqref{assoc} is a pullback. We can set $g,h=e$ and $c=a$ so that $ae=ea=a$. 
 Instantiating the pullback property, there is a unique $b$ such that $ab=e$ and $ba=e$, that is, $b=a^{-1}$.
\end{proof}

Recall that a monoidal functor generalizes a monoid object (in turn, generalizing a monoid).
Similarly, a \emph{weakly affine monoidal functor} generalizes a group in the sense of the proposition above. 

\section{Weakly-affine monads}
\todo{Nome da scegliere e valutare se dare la def per una arbitraria gs}
\begin{mydefinition}
Let $T$ be a commutative monad on a category $\mA$ with finite products. A triple $(X,Y,Z)$ of objects of $\mA$ is said to be \textbf{TBA} if the commutative square 
\[\begin{tikzcd}[column sep=3.3pc]
			T(X) \times T(Y) \times T(Z) \ar{r}{\id \times c_{Y,Z}} \ar[swap]{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
			T(X \times Y) \times T(Z) \ar{r}{c_{X\times Y,Z}}						& T(X \times Y \times Z)
		\end{tikzcd}
		\]
		is a pullback.
\end{mydefinition}

\todo{esempi?}
\begin{mydefinition}
	Let $T$ be a commutative monad on a category $\mA$ with finite products. 
	We say that the monad $T$ is \textbf{weakly affine} if the
	following associativity diagram is a pullback for every $X,Y,Z$ in $\mA$:
	\begin{equation}
		\label{c_assoc_pullback}
		\hspace{-9pt}	% T: for centering the equation number
		\begin{tikzcd}[column sep=3.3pc]
			T(X) \times T(Y) \times T(Z) \ar{r}{\id \times c_{Y,Z}} \ar[swap]{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
			T(X \times Y) \times T(Z) \ar{r}{c_{X\times Y,Z}}						& T(X \times Y \times Z)
		\end{tikzcd}
	\end{equation}
\end{mydefinition}

Let us derive some general properties before looking at examples.
It is a standard fact that for any commutative monad $T$, the composite arrow
\[
	\begin{tikzcd}
		T(1) \times T(1) \ar{r}{c_{1,1}}	& T(1 \times 1) \ar{r}{\cong}	& T(1)		
	\end{tikzcd}
\]
equips $T(1)$ with the structure of a commutative monoid internal to $\mathcal{A}$ with unit $\freccia{1}{\eta_1}{T(1)}$.

\begin{mylemma}
	\label{lem:T1_group}
	If $T$ is weakly affine, then $T(1)$ is a group.
\end{mylemma}

%\tob{It's possible to generalize the definition of weakly affine monad to the case where $\mA$ is merely gs-monoidal or even just symmetric monoidal. However, I have not implemented this (yet) since already the proof of this lemma does not generalize straightforwardly}

\begin{proof}
	If $T$ is weakly affine, then taking $X = Y = Z = 1$ in~\eqref{c_assoc_pullback} shows that this monoid must be an abelian group:
	assuming that $\times$ is a strict monoidal structure for simplicity, we obtain a unique arrow $\freccia{T(1)}{\iota}{T(1)}$ such that the diagram
	\[
		\begin{tikzcd}
			T(1) \ar{dr}[description]{(\id,\iota,\id)} \ar[bend left]{drr}{(\id,\eta_1 !)} \ar[bend right,swap]{ddr}{(\eta_1 !,\id)} \\
			&	T(1) \times T(1) \times T(1) \ar{r}{\id \times c_{1,1}} \ar[swap]{d}{c_{1,1} \times \id}	& T(1) \times T(1) \ar{d}{c_{1,1}}	\\
			&	T(1) \times T(1) \ar{r}{c_{1,1}}								& T(1)
		\end{tikzcd}
	\]
	and the commutativity shows that $\iota$ satisfies the equations making it the inversion map for a group structure.
\end{proof}
\todo{Mi sembra che nel caso $T$ sia weakly affine allora $T(1)\cong !$ nella Kleisli $A_T$. Bisogna vedere se Ã¨ vero che $T(\eta_1)\iota=\eta_{T(1)}$ }

\begin{mycorollary}
Let $T$ be a weakly affine monad. Then $T(1)\cong 1$ in the Kleisli category $\mA_T$.
\end{mycorollary}
\begin{proof}
We know from Lemma~\label{lem:T1_group} that $T(1)$ is a group in $\mA$, where the arrow $\freccia{1}{\eta_1}{T(1)}$ is the unit of the group, and $\freccia{T(1)}{\iota}{T(1)}$ is the inversion map. Therefore, we have that the composition $\freccia{1}{\iota\eta_1}{T(1)}$ has to be equal to $\eta_1$. Therefore, we can consider the arrows $1\to T(1)$ and $T(1)\to 1$ in the Kleisli category $\mA_T$ given by $T(\eta_1)\eta_1$ and $\iota$ respectively. The composition $T(\eta_1)\eta_1$ with $\iota$ in $\mA_T$ is given by $\mu_{1,1}T(\iota)T(\eta_1)\eta_1$. Employing the naturality of $\eta_1$ and the fact that $\iota\eta_1=\eta_1$, it is direct to check that $\mu T(\iota)T(\eta_1)\eta_1=\eta_1$, that is the identity $1\to 1$ in $\mA_T$. Now to show that the other composition gives the identity on $T(1)$ in $\mA_T$, it is enough to show that $T(\eta_1)\iota=\eta_{T(1)}$??.

\todo[inline]{(Paolo) Credo che $T(\eta_1)\iota\ne\eta_{T(1)}$ nell'esempio delle misure nonzero. Per ogni $x$ in $(0,\infty)=T1$ abbiamo che $\eta_{T(1)}(x)=\delta_x$ (delta di Dirac), mentre $T\eta_1(\iota(x)) = T\eta_1(1/x) = 1/x\,\delta_1$.}

\end{proof}
The following result shows that weak affinity occurs frequently. 
Recall that a strong monad $\freccia{\mA}{T}{\mA}$ on a category $\mA$ with finite products is \textbf{affine} if $T(1)\cong 1$ (see also Remark~\ref{rem:affine monad}). Three relevant examples of affine monads are the distribution monad on $\Set$ (for discrete probability), the Giry monad on the category of measurable spaces (for measure-theoretic probability, see Examples~\ref{ex: Giry monad} and~\ref{ex:Stoch and QBS_P are gs-monoidal}), and the expectation monad, see~\cite{Jacobs16}.

\begin{myproposition}\label{prop:every affine commutative monad is weakly affine}
	Let $T$ be a commutative monad on a category $\mA$ with finite limits. 
	If $T$ is affine, then it is weakly affine.
\end{myproposition}

\begin{proof}
	Let $m_{X,Y} : T(X \times Y) \longrightarrow TX \times TY$
	be the arrow defined as the pairing of $T(\pi_1)$ and $T(\pi_2)$.
	Then it is known that $T$ is affine if and only if $m_{X,Y} c_{X,Y} = \id_{TX \times TY}$~\cite[Lemma~4.2(i)]{Jacobs1994}.\footnote{For probability monads, this equation can be interpreted as stating that the marginals of a product distribution are the original factors~\cite{Fritz2018}.}
	In particular, $c_{X,Y}$ is a split mono and therefore mono.

	To show that~\eqref{c_assoc_pullback} is a pullback, we prove the universal property starting with a diagram
	\begin{equation}
		\label{candidate_pullback}
		\begin{tikzcd}[column sep=3pc]
			A \ar[bend left]{drr}{(f_1, f_2)} \ar[bend right,swap]{ddr}{(g_1, g_2)} \ar[dashed]{dr}{\exists!}							\\
				& TX \times TY \times TZ \ar{r}{\id \times c_{Y,Z}} \ar[swap]{d}{c_{X,Y} \times \id}	& TX \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
				& T(X \times Y) \times TZ \ar{r}{c_{X\times Y,Z}}						& T(X \times Y \times Z)
		\end{tikzcd}
	\end{equation}
	where the dashed arrow will be constructed; its uniqueness is clear since $\id \times c_{Y,Z}$ and $c_{X,Y} \times \id$ are mono, so it remains to prove existence.
	Taking the unlabelled arrows to be (induced by) product projections, we have the commutative diagram
	\iffalse
	\[
		\begin{tikzcd}[column sep=small]
			A \ar{r}{(g_1, g_2)} \ar[swap]{d}{(f_1, f_2)}					& T(X \times Y) \times TZ \ar{r}{c_{X \times Y, Z}} 	& T(X \times Y \times Z) \ar{d}	\\
			TX \times T(Y \times Z) \ar{rr}	\ar["c_{X,Y \times Z}" description]{urr} 	&							& T(Y \times Z)
		\end{tikzcd}
	\]
	\fi
% https://q.uiver.app/?q=WzAsNSxbMCwwLCJBIl0sWzEsMCwiVChYXFx0aW1lcyBZKVxcdGltZXMgVFoiXSxbMCwxLCJUWFxcdGltZXMgVChZXFx0aW1lcyBaKSJdLFszLDAsIlQoWFxcdGltZXMgWVxcdGltZXMgWikiXSxbMywxLCJUKFlcXHRpbWVzIFopIl0sWzAsMSwiKGdfMSxnXzIpIl0sWzAsMiwiKGZfMSxmXzIpIiwyXSxbMyw0XSxbMiw0XSxbMiwzLCJjX3tYLFlcXHRpbWVzIFp9IiwxXSxbMSwzXV0=
\[\begin{tikzcd}[column sep=tiny]
	A & {T(X\times Y)\times TZ} && {T(X\times Y\times Z)} \\
	{TX\times T(Y\times Z)} &&& {T(Y\times Z)}
	\arrow["{(g_1,g_2)}", from=1-1, to=1-2]
	\arrow["{(f_1,f_2)}"', from=1-1, to=2-1]
	\arrow[from=1-4, to=2-4]
	\arrow[from=2-1, to=2-4]
	\arrow["{c_{X,Y\times Z}}"{description}, from=2-1, to=1-4]
	\arrow[from=1-2, to=1-4]
\end{tikzcd}\]
	where the upper left triangle commutes by assumption, and the lower right triangle commutes by naturality of $c$ with respect to the unique arrow $X \to 1$ together with $T1 \cong 1$ and the fact that $c_{1,Y \times Z}$ is a coherence isomorphism.
	By the naturality of $c$, $f_2$ can be written as the composite
	\[
		\begin{tikzcd}[column sep=scriptsize]
			A \ar{r}{(g_1, g_2)}	& T(X \times Y) \times TZ \ar{r}	& TY \times TZ \ar{r}{c_{Y,Z}}	& T(Y \times Z).			
		\end{tikzcd}
	\]
	By analogous reasoning, we identify $g_1$ with the composite
	\[
		\begin{tikzcd}[column sep=scriptsize]
			A \ar{r}{(f_1, f_2)}	& TX \times T(Y \times Z) \ar{r}	& TX \times TY \ar{r}{c_{X,Y}}	& T(X \times Y).			
		\end{tikzcd}
	\]
	Getting back to~\eqref{candidate_pullback}, we take the dashed arrow to be the arrow whose component on $TX$ is given by $f_1$, on $TZ$ by $g_2$, and on $TY$ by the diagonal in the diagram
	\[
		\begin{tikzcd}
			A \ar{r}{f_2} \ar[swap]{d}{g_1}	& T(Y \times Z)	\ar{d}	\\
			T(X \times Y) \ar{r}		& TY
		\end{tikzcd}
	\]
	which commutes for similar reasons as above.
	The fact that this arrow recovers the $f_2$ component after composition with $\id \times c_{Y,Z}$ and the $g_1$ component after composition with $c_{X,Y} \times \id$ follows by the expressions for $f_2$ and $g_1$ derived above.
	The fact that it recovers $f_1$ and $g_2$ is by construction.

\end{proof}

\begin{myremark}
	We are not aware of any relation between weakly affine monads in our sense and Jacobs' \emph{strongly affine} monads~\cite{Jacobs16}, other than the fact that strongly affine implies affine implies weakly affine.
\end{myremark}

\begin{myexample}
	\label{ex:abelian_group}
	We present a family of examples of commutative monads that are weakly affine but not affine.
	Let $A$ be an abelian group (written multiplicatively).
	Then the functor $T_A \coloneqq A \times -$ on $\Set$ has a canonical structure of commutative monad, 
	where the lax structure components $c_{X,Y}$ are given by multiplying elements in $A$ while carrying the elements 
	of $X$ and $Y$ along.

	Since $T_A \cong A$, the monad $T_A$ is clearly not affine unless $A$ is the trivial group.
	However, $T_A$ is always weakly affine.
	Indeed, in order to show that~\eqref{c_assoc_pullback} is a pullback, it suffices to show that the associativity square of $A$
	\[
		\begin{tikzcd}
			A \times A \times A \ar{r}{\id \times \cdot} \ar{d}{\cdot \times \id}		& A \times A \ar{d}{\cdot}	\\
			A \times A \ar{r}{\cdot}							& A
		\end{tikzcd}
	\]
	is a pullback.
	Using element-wise reasoning, this amounts to showing that the system of equations
		$ax = c$ and $xb = d$
	has a solution for $x \in A$ if and only if $cb = ad$, and in this case the solution is unique.
	But this is indeed the case with $x = a^{-1} c = db^{-1}$.
	(Note that this argument does not even require $A$ to be abelian, but we need to require this in order for $T_A$ to be commutative.)
\end{myexample}

\begin{myexample}
	Many monads in categorical measure theory are weakly affine but not affine.
	Let e.g. $M^* : \Set \to \Set$ be the monad assigning to every set the set of finitely supported discrete \emph{nonzero}
	measures on $M^*$, or equivalently let $M^*(X)$ for any set $X$ be the set of nonzero finitely supported functions $X \to [0,\infty)$.
	The monad structure is defined in terms of the same formulas as for the distribution monad on $\Set$ and the
	components $c_{X,Y}$ are also given by the formation of product measures, or equivalently point-wise products of functions 
	$X \to [0,\infty)$.

	Since $M^* 1 \cong (0,\infty)$, this monad is clearly not affine.
	However, it is weakly affine, and we limit ourselves to a sketch of the proof.
	Indeed to prove that~\eqref{c_assoc_pullback} is a pullback, we again reason in terms of elements.
	If all measures are normalised, then we are back in the situation of the distribution monad, which is affine and the claim follows.
	In the general case, one can reduce to the normalised case by showing that the normalisation of the desired element of $M^*(Y)$ is uniquely determined.
	This works in the same way as in Example~\ref{ex:abelian_group} with $A = (0,\infty)$.

	On the other hand, if the zero measure is included, then we obtain a commutative monad $M$ which can be seen as the monad of semimodules for the semiring of nonnegative reals.
	Since $M1 \cong [0,\infty)$ is not a group under multiplication, $M$ is not weakly affine.
\end{myexample}

The previous two examples and Lemma~\ref{lem:T1_group} suggest the following problem.

\begin{myproblem}
	Let $T$ be a commutative monoid such that $T(1)$ is an abelian group. Does it follow that $T$ is weakly affine?
\end{myproblem}


\end{document}


