\documentclass[a4paper,UKenglish,numberwithinsect,cleveref, autoref, thm-restate]{lipics-v2021}

\bibliographystyle{plainurl} % the mandatory bibstyle


%\usepackage{natbib}
\usepackage{graphicx}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{float}
\usepackage{amsfonts}
\usepackage{amssymb}
\include{macro_davide}
\usepackage{mathtools}
\usepackage{quiver}
\usepackage{cleveref}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage[all,2cell]{xy}
\UseAllTwocells
\xyoption{v2}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{tikz}
\usepackage{tikzit}

\usetikzlibrary{shapes}

%\input{sample.tikzstyle}
\usepackage{freetikz}
\usetikzlibrary{decorations.markings,positioning,patterns}
\usetikzlibrary{shadows}
\usepackage{array}

%\usetikzlibrary{automata, positioning, arrows}
\input{stringdiagrams.tikzstyles}
\usepackage{todonotes}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\theoremstyle{plain} %italico
\newtheorem{mytheorem}{Theorem}[section]
\newtheorem{mycorollary}[mytheorem]{Corollary}
\newtheorem{mylemma}[mytheorem]{Lemma}
\newtheorem{myproposition}[mytheorem]{Proposition}


\theoremstyle{definition} %stampatello
\newtheorem{mydefinition}[mytheorem]{Definition}
\newtheorem{myproblem}[mytheorem]{Problem}

\newtheorem{myremark}[mytheorem]{Remark}
\newtheorem{myexample}[mytheorem]{Example}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newcommand{\stringdiagnabla}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (0) at (-4.25, 0) {};
		\node [style=none] (1) at (-2.75, 0.5) {};
		\node [style=none] (2) at (-2.75, -0.5) {};
		\node [style=none] (3) at (-2, -0.5) {};
		\node [style=none] (4) at (-2, 0.5) {};
		\node [style=nodonero] (5) at (-3.25, 0) {};
		\node [style=none] (7) at (-3.75, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (0.center) to (5);
		\draw [bend left, looseness=1.25] (5) to (1.center);
		\draw (1.center) to (4.center);
		\draw [bend right] (5) to (2.center);
		\draw (2.center) to (3.center);
	\end{pgfonlayer}
	\pgfsetbaseline{-0.4ex}
\end{tikzpicture}}


\newcommand{\stringdiagbang}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (8) at (2, 0) {};
		\node [style=nodonero] (9) at (3, 0) {};
		\node [style=none] (10) at (2.5, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (8.center) to (9);
	\end{pgfonlayer}
		\pgfsetbaseline{-.4ex}
\end{tikzpicture}}

\newcommand{\stringdiagidentity}[1]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=none] (8) at (2, 0) {};
		\node [style=none] (9) at (3, 0) {};
		\node [style=none] (10) at (2.5, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (8.center) to (9);
	\end{pgfonlayer}
		\pgfsetbaseline{-.4ex}
\end{tikzpicture}}
\newcommand{\stringdiagfreccia}[3]{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=box] (5) at (1.75, 0) {#2};
		\node [style=none] (7) at (3, 0) {};
		\node [style=none] (8) at (2.5, 0.25) {#3};
		\node [style=none] (9) at (0.5, 0) {};
		\node [style=none] (10) at (1, 0.25) {#1};
	\end{pgfonlayer}
	\begin{pgfonlayer}{edgelayer}
		\draw (5) to (7);
		\draw (9.center) to (5);
	\end{pgfonlayer}
	\pgfsetbaseline{-.4ex}
\end{tikzpicture}
}
\newcommand{\nodo}{\begin{tikzpicture}[scale=0.60, transform shape]
	\begin{pgfonlayer}{nodelayer}
		\node [style=nodonero] (0) at (0, 0) {};
	\end{pgfonlayer}
	\pgfsetbaseline{-.4ex}
\end{tikzpicture}}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\title{Weakly-affine monads}
\titlerunning{Weakly-affine monads}

\author{Tobias Fritz}{Department of Mathematics, University of Innsbruck, AT}{tobias.fritz@uibk.ac.at}{}{}
\author{Paolo Perrone}{Department of Computer Science, University of Oxford, UK}{paolo.perrone@cs.ox.ac.uk}{https://orcid.org/0000-0002-9123-9089}{}
\author{Fabio Gadducci}{Department of Computer Science, University of Pisa, Pisa, IT}{fabio.gadducci@unipi.it}{https://orcid.org/
0000-0003-0690-3051}{}
\author{ Davide Trotta }{Department of Computer Science, University of Pisa, Pisa, IT}{trottadavide92@gmail.com}{https://orcid.org/0000-0003-4509-594X}{}
\authorrunning{F. Gadducci et alii}
%The research is supported by the MIUR PRIN 2017FTXR "IT-MaTTerS"

\Copyright{Tobias Fritz and Fabio Gadducci and Paolo Perrone and Davide Trotta} 
\ccsdesc[500]{}


\keywords{String diagrams, gs-monoidal and Markov categories, categorical probability, affine monads.} %TODO mandatory; please add comma-separated list of keywords

\begin{document}

\maketitle

%\todo[inline]{T: I think that ``weakly-affine'' should be ``weakly affine'' throughout, yes?}

\begin{abstract}
   Introduced in the 1990s in the studies of the algebraic approach to graph rewriting, 
   gs-monoidal categories (shortly, GS categories) are symmetric monoidal categories 
   where each object has the structure of a commutative comonoid. They arise as the 
   underlying structure of Klesli categories for commutative monads on cartesian categories, 
   and as such provide an handy tool for approaching effectfull computations. 
   Recently proposed in the context of categorical probability, Markov categories are
   GS categories where the monoidal unit is also terminal, and they characterises 
   those Kleisli categories where the monad is required to preserve such an object.

   The aim of this paper is to study the different strengthenings on the monoidal structure 
   leading from GS categories up to Markov and cartesian ones. More precisely, we 
   focus on the introduction of weakly Markov categories, where morphisms to the monoidal 
   unit are not necessarily unique, but form a group. As we show, these categories exhibit a 
   rich theory of conditional 
   independence, generalising the case of Markov categories. We also introduce the corresponding 
   notion for commutative monads, which we call weakly affine, and for which we give two equivalent
   characterisations.

   The paper argues that such monads are relevant to the study of categorical probability.
   A case at hand is the monad of non-negative, non-zero measures, which is not affine, 
   yet weakly so. With these structures, one can investigate probability 
   ``up to normalisation'' in a precise categorical way.
\end{abstract}

\section{Introduction}



For context:
\begin{myproposition}\label{assoc_group}
 A monoid $(M,m,e)$ is a group if and only if the associativity square
 \begin{equation}\label{assoc}
  \begin{tikzcd}
   M \times M \times M \ar{d}{\id\times m} \ar{r}{m\times\id} & M\times M \ar{d}{m} \\
   M\times M \ar{r}{m} & M
  \end{tikzcd}
 \end{equation}
 is a pullback.
\end{myproposition}
This statement holds generally for a monoid object in a cartesian monoidal category, where the following elementwise proof still applies by the Yoneda lemma.
\begin{proof}
 The square~\eqref{assoc} is a pullback, both of sets and of groups, if and only if given $a,g,h,c\in M$ such that $ag=hc$, there exists a unique $b\in M$ such that $g=bc$ and $h=ab$.
 First, suppose that $G$ is a group. Then the only possible choice of $b$ is 
 \[
  b = a^{-1}h = gc^{-1},
 \]
 which is unique by uniqueness of inverses. 
 
 Conversely, suppose that \eqref{assoc} is a pullback. We can set $g,h=e$ and $c=a$ so that $ae=ea=a$. 
 Instantiating the pullback property on these elements gives $b$ such that $ab=e$ and $ba=e$, that is, $b=a^{-1}$.
\end{proof}
\begin{definition}\label{monadM}
 Let $X$ be a set. Denote by $MX$ the set of \emph{finitely supported measures on $X$}, i.e.~functions $m:X\to[0,\infty)$ which are zero for all but a finite number of $x\in X$. 
 Given a function $f:X\to Y$, denote by $Mf:MX\to MY$ the function sending $m\in MX$ to the assignment
 \[
	 (Mf)(m) : y \mapsto \sum_{x\in f^{-1(y)}} p(x) .
 \]
 This makes $M$ into a functor, and even a monad with the following unit and multiplication maps.
 \[
  \begin{tikzcd}[row sep=0]
   X \ar{r}{\delta} & MX \\
   x \ar[mapsto]{r} & \delta_x ,
  \end{tikzcd}
  \qquad\qquad
  \begin{tikzcd}[row sep=0]
   MMX \ar{r}{E} & MX \\
   \xi \ar[mapsto]{r} & E\xi ,
  \end{tikzcd}
 \]
 where 
 \[
  \delta_x(x') = \begin{cases}
                  1 & x=x' , \\
                  0 & x\ne x',
                 \end{cases}
 \qquad\qquad
 (E\xi)(x) = \sum_{m\in MX} \xi(m)\,m(x) .
 \]
 Call $M$ the \emph{measure monad} on $\Set.$

 Denote also by $DX\subseteq MX$ the subset of \emph{probability measures}, i.e. those finitely supported $p:X\to[0,\infty)$ such that
 \[
  \sum_{x\in X} p(x) = 1 .
 \]
 $D$ forms a submonad of $M$ called the \emph{distribution monad}.
\end{definition}


\subsection{GS-monoidal and Markov categories}

The notion of \emph{gs-monoidal category} has been originally introduced in the context of algebraic approaches to term graph rewriting~\cite{CorradiniGadducci97}, and then
developed in a series of papers \cite{CorradiniGadducci99, CorradiniGadducci02, CorradiniGadducci99b}.
We recall here the basic definitions adopting the graphical formalism of string diagrams,
%at the same time highlighting all the basic 
%    properties underlying its structure.
%
%
%in terms of string diagrams.
referring to \cite{Selinger2011} for background on various notions of monoidal categories and their associated diagrammatic calculus.

%\todo[inline]{T: The text has contained both terms ``gs-monoidal category'' and ``GS-category'', and it would probably be better to stick with one of these two. I've opted for the former now since that's what it's in the literature, but ``GS category'' with or without dash seems fine too (and perhaps the people who prefer to say ``CD category'' could be convinced to say ``GS category'' instead)}

\begin{definition}
A \textbf{gs-monoidal category} is a symmetric monoidal category $(\mC, \otimes, I)$
with a commutative comonoid structure on each object X, consisting of a comultiplication
and a counit,
\ctikzfig{copy_del}
which satisfy the commutative comonoid equations:
\ctikzfig{comonoid_equation}
These comonoid structures must be multiplicative with respect to the monoidal structure:
\ctikzfig{comon-struct-mult}

\end{definition}


% monoidal monad
% examples with M and D, Stoch etc

\begin{definition}
 A morphism $f:X\to Y$ in a gs-monoidal category is called \textbf{copyable} or \textbf{functional} if and only if
 \ctikzfig{functional}
 It is called \textbf{discardable} or \textbf{full} if 
 \ctikzfig{full}
\end{definition}

\begin{example}
The category $\Rel$ of sets and relations with the monoidal operation $\otimes : \Rel \times \Rel\to \Rel$ the given by the direct product of sets is a gs-monoidal category \cite{CorradiniGadducci02}. In this gs-monoidal category, the copyable arrows are precisely the partial functions, and the discardable arrows are the total relations.
\end{example}
\begin{remark}
It is well-known that if duplicators and dischargers of a given gs-monoidal category $\mC$ satisfy naturality, then the monoidal product is the categorical product, and thus the category is cartesian monoidal \cite{Fox:CACC},~i.e. the following conditions are equivalent for a gs-monoidal category $\mC$:
 \begin{itemize}
  \item $\mC$ is cartesian monoidal;
  \item every morphism is copyable and discardable;
  \item the copy and discard maps are natural.
 \end{itemize}
\end{remark}
In recent works \cite{tba} it has been proved that gs-monoidal structure naturally arises in several situations, such as Kleisli categories of commutative monads or span categories. In the following proposition, we recall the result regarding Kleisli categories:
\begin{proposition}\label{monoidalgs}
 Let $T$ be a symmetric monoidal (equivalently, commutative) monad on a cartesian monoidal category $\mD$. 
 Then $\mathrm{Kl}_T$ is canonically a gs-monoidal category with copy and discard structure induced by that of $\mD$.
\end{proposition}
Nowadays, \emph{Markov categories}~\cite{Fritz_2020} represent one of the more interesting specializations of the notion of gs-monoidal category. Based on the interpretation of their arrows
 as generalised Markov kernels, Markov categories are considered the foundation for a categorical approach to probability theory.


In the following, we recall some (equivalent) definition of such categories:
\begin{definition}
 A gs-monoidal category is said to be a \textbf{Markov category} if any (hence all) of the following equivalent conditions are satisfied:
 \begin{itemize}
  \item the monoidal unit is terminal;
  \item the discard map is natural;
  \item every morphism is discardable.
 \end{itemize}
\end{definition}
%examples

We recall from \cite{Kock71,Jacobs1994} the notion of \emph{affine monad}:
\begin{definition}
 A monad $T$ on a cartesian monoidal category is called \textbf{affine} if $T1\cong 1$.
\end{definition}
It was observed in~\cite[Corollary~3.2]{Fritz_2020} that if the monad preserves the terminal object, then every arrow of the Kleisli category is discardable, and this makes Kleisli category into a Markov category. Therefore, we have the following specialization of \Cref{monoidalgs}:
\begin{proposition}\label{affinemarkov}
Let $T$ be a symmetric monoidal (equivalently, commutative) monad on a cartesian monoidal category $\mD$. Then $\mathrm{Kl}_T$ is Markov if and only if $T$ is affine.
\end{proposition}
 

\section{Weakly Markov categories and weakly affine monads}

In this section, we introduce an intermediate level between gs-monoidal and Markov called \emph{weakly Markov}, and its corresponding notion for monads, which we call \emph{weakly affine}.
\subsection{The monoid of effects}\label{monoids}

In a gs-monoidal category $\mC$ we call a \emph{state} a morphism from the monoidal unit $p:I\to X$, and \emph{effect} or \emph{co-state} a morphism to the monoidal unit $a:X\to I$. We represent them as triangles as follows.
 \ctikzfig{state-costate}

 Effects, i.e.~elements of the set $\mC(X,I)$, form canonically a commutative monoid as follows: the monoidal unit is the discard map $X\to I$, and given $a,b:X\to I$, their product $ab$ is given by copying:\footnote{See e.g.~also the $\odot$ product in~\cite[Proposition~3.10]{coecke2011phasegroups}.}
\ctikzfig{ptwise-product}
If a morphism $f:X\to Y$ is copyable and discardable, precomposition with $f$ induces a morphism of monoids $\mC(Y,I)\to\mC(X,I)$. 

Let's now consider the case where the gs-monoidal structure comes from a commutative monad on a cartesian monoidal category $\mD$. 
In this case, the monoid structure of Kleisli morphisms $X\to 1$ comes from the following canonical internal monoid structure of $T1$ in $\mD$, given by~\cite[Section~10]{kock2012distributions}
 \[
 \begin{tikzcd}
  1 \ar{r}{\eta} & T1 ,
 \end{tikzcd}
 \qquad
 \begin{tikzcd}
  T1 \times T1 \ar{r}{c} & T(1\times 1) \ar{r}{\cong} & T1 .
 \end{tikzcd}
 \]
 For example, for the monad of measures $M$, we obtain $M1=[0,\infty)$ with its usual multiplication.
 
 The monoid structure of Kleisli morphisms $X\to 1$ is now given as follows. The unit is given by
 \[
 \begin{tikzcd}
  X \ar{r}{!} & 1 \ar{r}{\eta} & T1 ,
 \end{tikzcd}
 \]
 and the multiplication of the morphisms $f^\sharp,g^\sharp:X\to T1$ is
 \[
 \begin{tikzcd}
  X \ar{r}{\mathrm{copy}_X} & X\times X \ar{r}{f^\sharp\times g^\sharp} &
  T1 \times T1 \ar{r}{c} & T(1\times 1) \ar{r}{\cong} & T1 .
 \end{tikzcd}
 \]
 For the monad of measures $M$, Kleisli morphisms $X\to 1$ are functions $X\to [0,\infty)$, and their monoidal structure is their pointwise product. 

Note that the commutative monoid $\mC(X,I)$ acts on the set $\mC(X,Y)$: given $a:X\to I$ and $f:X\to Y$, the resulting $a\cdot f$ is given as follows,
\ctikzfig{action}
and the product $(f,g)\mapsto f\cdot g \coloneqq (f\otimes g)\circ\mathrm{copy}_X$ is equivariant for this action in both variables (separately). 
For the monad of measures $M$, this action amounts to a pointwise rescaling.

\subsection{Main definitions}


\begin{mydefinition}
 A gs-monoidal category $\mC$ is called \textbf{weakly Markov} if for every object $X$, the monoid $\mC(X,I)$ is a group. 
\end{mydefinition}

Every Markov category is weakly Markov: for each $X$, the monoid $\mC(X,I)$ is the trivial group.

\todo[inline]{T: Instead of saying ``weakly Markov GS-category'', perhaps we can just say ``weakly Markov category''?}
\todo[inline]{P: Right. At the risk of starting a grammar discussion, I feel I should point out that ``weak Markov'' sound better. (Is ``Markov'' also an adjective in English? In Italian we would have ``markoviano'' for that.}

\begin{mydefinition}
 Given two parallel morphisms $f,g:X\to Y$ in a weakly Markov category $\mC$, we say that $f$ and $g$ are:
 \begin{enumerate}
  \item \emph{equivalent}, denoted $f\sim g$, if they lie in the same orbit for the action of $\mC(X,I)$, i.e.~if there is $a\in \mC(X,I)$ such that $a\cdot f=g$.
  \item \emph{uniquely equivalent} if there is a unique $a\in \mC(X,I)$ such that $a\cdot f=g$.
 \end{enumerate}
\end{mydefinition}

\todo[inline]{T: Isn't the equivalence always unique? The action of $\mC(X, I)$ on $\mC(X, Y)$ is free, as one can easily see by discarding $Y$. That's basically also the argument used in \Cref{eqcondind} below}
\todo[inline]{P: Oh, good point. This simplifies things, let me write the changes.}

\todo[inline]{T: Is it worth noting that the equivalence classes form a Markov cat, which is isomorphic to the Markov cat of discardable morphisms?}
\todo[inline]{P: Yes, I was thinking about it. It is interesting for nonzero measures, because we get the usual FinStoch, but for the example of $G\times -$ we just get the terminal monad. It's true though that it's worth mentioning.}


Let's now look at the Kleisli case.

\begin{mydefinition}
 A commutative monad $T$ on a cartesian monoidal category is called \textbf{weakly affine} if $T1$ with its canonical internal monoid structure is a group.
\end{mydefinition}

This choice of terminology is motivated by the following proposition, which can be seen as a ``weakly'' version of \Cref{affinemarkov}.

\begin{myproposition}\label{weaklyboth}
 Let $\mD$ be a cartesian monoidal category, and let $T$ be a commutative monad on $\mD$. Then the Kleisli category of $T$ is weakly Markov if and only if $T$ is weakly affine.
\end{myproposition}
\begin{proof}
 First, suppose that $T1$ is an internal group, and denote by $\iota:T1\to T1$ its inversion map. 
 The inverse of a Kleisli morphism $a : X \to 1$ in $\mathrm{Kl}_T(X,1)$ represented by $a^\sharp:X\to T1$ is represented by $\iota\circ a^\sharp$: indeed, the following diagram in $\mD$ commutes,
 \[
  \begin{tikzcd}
  X \ar[bend right=5pc]{dd}[swap]{!} \ar{d}[swap]{a^\sharp} \ar{r}{\mathrm{copy}_X} & X\times X \ar{d}[swap]{a^\sharp\times a^\sharp} \ar{dr}{a^\sharp\times(\iota\circ a^\sharp)} \\
  T1 \ar{d}[swap]{!} \ar{r}[swap]{\mathrm{copy}_X} & T1\times T1 \ar{r}[swap]{\id\times\iota} & T1\times T1 \ar{r}{c} & T(1\times 1) \ar{d}{\cong} \\
  1 \ar{rrr}{\eta} &&& T1
  \end{tikzcd}
 \]
 where the bottom rectangle commutes since $\iota$ is the inversion map for $T1$. The analogous diagram with $\iota\times\id$ in place of $\id\times\iota$ commutes analogously.
 
 Conversely, suppose that for every $X$, the monoid structure on $\mathrm{Kl}_T(X,1)$ has inverses. Then in particular we can take $X=T1$, and the inverse of the Kleisli morphism $\id:T1\to T1$ is an inversion map for $T1$. 
\end{proof}

This result can also be thought of in terms of the Yoneda embedding, see the details in \Cref{yoneda}.


\subsection{Examples of weakly affine monads} 

Every affine monad is a weakly affine monad. Here are less trivial examples.

\begin{myexample}
    \label{ex:nonzero_measures}
	Let $M^* : \Set \to \Set$ be the monad assigning to every set the set of finitely supported discrete \emph{nonzero}
	measures on $M^*$, or equivalently let $M^*(X)$ for any set $X$ be the set of nonzero finitely supported functions $X \to [0,\infty)$.
	The monad structure is defined in terms of the same formulas as for the monad of measures $M$ (\Cref{monadM}) and the
	components $c_{X,Y}$ are also given by the formation of product measures, or equivalently pointwise products of functions 
	$X \to [0,\infty)$.

	Since $M^* 1 \cong (0,\infty)\ncong 1$, this monad is not affine. However the monoid structure of $(0,\infty)$ induced by $M^*$ is the usual multiplication of positive real numbers, which form a group. Therefore $M^*$ is weakly affine, and its Kleisli category is weakly Markov.

	\todo[inline]{T: More generally, we could consider nonzero measures with values in any positive semifield, see the corresponding monads considered in \href{https://arxiv.org/abs/2108.10718}{arXiv:2108.10718}. Not sure though if it's interesting enough to mention?}

	On the other hand, if the zero measure is included, we have $M1 \cong [0,\infty)$ which is not a group under multiplication, so $M$ is not weakly affine.
\end{myexample}

\begin{myexample}
	\label{ex:abelian_group}
	Let $A$ be a commutative monoid.
	Then the functor $T_A \coloneqq A \times -$ on $\Set$ has a canonical structure of commutative monad, 
	where the lax structure components $c_{X,Y}$ are given by multiplying elements in $A$ while carrying the elements 
	of $X$ and $Y$ along.

	Since $T_A(1) \cong A$, the monad $T_A$ is weakly affine if and only if $A$ is a group, and affine if and only if $A\cong 1$.
\end{myexample}

\begin{myexample}
    \label{ex:nonexample}
    Here is a negative example.
    Consider the free abelian group monad $F$ on $\Set$. Its functor takes a set $X$ and forms the set $FX$ of finite multisets (with repetition, where order does not matter) of elements of $X$ and their formal inverses. 
    We have that $F1\cong \mathbb{Z}$, which is an abelian group under addition. 
    However, the monoid structure on $F1$ induced by the monoidal structure of the monad corresponds to the \emph{multiplication} in $\mathbb{Z}$, which does not have inverses. Therefore $F$ is not weakly affine. 
\end{myexample}


\section{Conditional independence in weakly Markov categories}

Markov categories have a rich theory of conditional dependence and independence \cite{fritz2022dseparation}. 
Some of those ideas can be translated and generalized to the setting of weakly Markov categories. 

\begin{mydefinition}\label{defcondind}
 A morphism $f:A\to X_1\otimes\dots\otimes X_n$ in a gs-monoidal category $\mC$ is said to exhibit \emph{conditional independence of the $X_i$ given $A$} if and only if it can be expressed as a product of the following form.
 \ctikzfig{cond-ind-sep}
\end{mydefinition}

Note that this is slightly different from \cite[Definition~6.6]{cho_jacobs_2019}, although it is equivalent for the case of Markov categories.

\todo[inline]{How is it different? It looks to me like they consider it only for conditionals of states and require that equation to hold only with almost sure equality, but that means that it's slightly different already for Markov cats}


Here is what conditional independence looks like in the Kleisli case.

\begin{myproposition}\label{indepkleisli}
 Let $\mD$ be a cartesian monoidal category, and let $T$ be a commutative monad on $\mD$.
 A Kleisli morphism represented by $f^\sharp:A\to T(X_1\times\dots\times X_n)$ exhibits conditional independence of the $X_i$ given $A$ if and only if it factors as follows
 \[
 \begin{tikzcd}
  A \ar{d}[swap]{(g_1^\sharp,\dots,g_n^\sharp)} \ar{dr}{f^\sharp} \\
  TX_1\times\dots\times TX_n \ar{r}[swap]{c} & T(X_1\times\dots\times X_n) ,
 \end{tikzcd}
 \]
 for some Kleisli maps $g_i^\sharp:A\to TX_i$,
 where the map $c$ above is the one obtained by iterating the multiplication of the monoidal structure (such a map is unique by associativity). 
\end{myproposition}
\begin{proof}
 In terms of the base category $\mD$, a Kleisli morphism in the form of \Cref{defcondind} reads as follows.
 \[
  \begin{tikzcd}[sep=large]
   A \ar{r}{\mathrm{copy}} & A\times\dots\times A \ar{r}{g_1^\sharp\times\dots\times g_n^\sharp} & TX_1\times\dots\times TX_n \ar{r}{c} & T(X_1\times\dots\times X_n) .
  \end{tikzcd}
 \]
 Therefore $f^\sharp:A\to T(X_1\times\dots\times X_n)$ exhibits the conditional independence if and only if it is of the form above.
\end{proof}

\begin{myexample}
 In the Kleisli category of the distribution monad $D$, which is Markov, a morphism $f:A\to X\otimes Y$ exhibits conditional independence if and only if it is is the product of its marginals~\cite[Section~12]{Fritz_2020}.
\end{myexample}

\begin{myexample}
 In the Kleisli category of the measure monad $M$, the zero measure always displays conditional independence of its outputs given its inputs: for example, for $A=1$, the zero measure on $X\times Y$ is the product of the zero measure on $X$ and the zero (or any other) measure on $Y$.
 Notice that both marginals of the zero measure are zero measures---therefore, the factors appearing in the product are not necessarily related to the marginals.
\end{myexample}

In a weakly Markov category, the situation is similar to the Markov case, but up to equivalence. 

\begin{myproposition}\label{eqcondind}
 Let $f:A\to X_1\otimes\dots\otimes X_n$ be a morphism in a weakly Markov category $\mC$. Then $f$ exhibits conditional independence of the $X_i$ given $A$ if and only if it is equivalent to the product of all its marginals.
 Moreover, in that case $f$ is \emph{uniquely} equivalent to the product of its marginals.
\end{myproposition}

\begin{proof}
 Denote the marginals of $f$ by $f_1,\dots,f_n$.
 Suppose that $f$ is a product as in \Cref{defcondind}. For each $i=1,\dots,n$, by marginalizing, we get that $f_i$ is equal to the following.
  \ctikzfig{cond-ind-proof} 
 Therefore for each $i$ we have that $f_i\sim g_i$. 
 
 Conversely, suppose that $f$ is equivalent to the product of its marginals, i.e.~that there exists $a:X\to I$ such that $f$ is equal to the following.
 \ctikzfig{cond-ind-proof2}
 One can then choose $g_i=f_i$ for all $i<n$, and $g_n = a\cdot f_n$, so that $f$ is in the form of \Cref{defcondind}.
 Moreover, by marginalizing over all the $X_i$ at once, we see that 
 \ctikzfig{cond-ind-proof3}
 so that $a$ is uniquely determined.
\end{proof} 
 
\begin{myremark}
 For $n=2$, a morphism $f:A\to X\otimes Y$ in a weakly Markov category $\mC$ exhibits conditional independence of $X$ and $Y$ given $A$ 
 if and only if the following equation holds.
 \ctikzfig{cond-ind2} 
\end{myremark}


\subsection{Main result}

The concept of conditional independence for general weakly Markov categories allows us to give an equivalent characterization of weakly affine monads.
The condition is in terms of a pullback condition on the associativity diagram, and can be seen as a generalization of \Cref{assoc_group}.

\begin{mytheorem}\label{mainthm}
 Let $\mD$ be a cartesian monoidal category, and let $T$ be a commutative monad on $\mD$.
 Then the following conditions are equivalent.
 \begin{enumerate}
  \item\label{condgroup} $T$ is weakly affine;
  \item\label{condwm} The Kleisli category $\mathrm{Kl}_T$ is weakly Markov;
  \item\label{condpullback} For all objects $X$, $Y$, and $Z$, the following associativity diagram is a pullback.
	\begin{equation}
		\label{assoc_pullback}
		\hspace{-9pt}	% T: for centering the equation number
		\begin{tikzcd}[column sep=3.3pc]
			T(X) \times T(Y) \times T(Z) \ar{r}{\id \times c_{Y,Z}} \ar[swap]{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
			T(X \times Y) \times T(Z) \ar{r}{c_{X\times Y,Z}}						& T(X \times Y \times Z)
		\end{tikzcd}
	\end{equation}
 \end{enumerate}
\end{mytheorem}

We prove the theorem by means of the following property of weakly Markov categories.

\begin{mylemma}[localized independence property]\label{local}
 Let $\mC$ be a weakly Markov category. Whenever a morphism  $f:A\to X\otimes Y\otimes Z$ exhibits conditional independence of $X\otimes Y$ (jointly) and $Z$ given $A$, as well as conditional independence of $X$ and $Y\otimes Z$ given $A$, then it exhibits conditional independence of $X$, $Y$ and $Z$ given $A$. 
\end{mylemma}
\begin{proof}[Proof of \Cref{local}]
 Suppose $f:A\to X\otimes Y\otimes Z$ exhibits conditional independence of $X\otimes Y$ (jointly) and $Z$ given $A$, as well as conditional independence of $X$ and $Y\otimes Z$ given $A$.
 By marginalizing out $X$, we have that $f_{YZ}$ exhibits conditional independence of $Y$ and $Z$ given $A$. 
 Since by hypothesis $f$ exhibits conditional independence of $X$ and $Y\otimes Z$ given $A$, by \Cref{eqcondind} we have that $f$ is equivalent to the product  of $f_X$ and $f_{YZ}$. But, again by \Cref{eqcondind}, $f_{YZ}$ is equivalent to the product of $f_Y$ and $f_Z$, so we have that $f$ is equivalent to the product of all its marginals. Using \Cref{eqcondind} in the other direction, this means that $f$ exhibits conditional independence of $X$, $Y$ and $Z$ given $A$. 
\end{proof}
 
We are now ready to prove the theorem.

\begin{proof}[Proof of \Cref{mainthm}]
 $\ref{condgroup}\Leftrightarrow\ref{condwm}$: 
 see \Cref{weaklyboth}.
 
 $\ref{condgroup}\Rightarrow\ref{condpullback}$: 
 By the universal property of products, a cone over the cospan in \eqref{assoc_pullback} consists of maps $g_1^\sharp:A\to TX$, $g_{23}^\sharp:A\to T(Y\times Z)$, $g_{12}^\sharp:A\to T(X\times Y)$ and $g_3^\sharp:A\to TZ$ such that the following diagram commutes. 
 \[
  \begin{tikzcd}[column sep=3.3pc]
   A \ar[bend left=10]{drr}{(g_1^\sharp,g_{23}^\sharp)} \ar[bend right=15]{ddr}[swap]{(g_{12}^\sharp,g_3^\sharp)} \\
   & T(X) \times T(Y) \times T(Z) \ar{r}[swap]{\id \times c_{Y,Z}} \ar{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
   & T(X \times Y) \times T(Z) \ar{r}[swap]{c_{X\times Y,Z}}						& T(X \times Y \times Z)
  \end{tikzcd}
 \]
 By \Cref{indepkleisli}, this amounts to a Kleisli map $f^\sharp:A\to T(X\times Y\times Z)$ exhibiting conditional independence of $X$ and $Y\otimes Z$ given $A$, as well as of $X\otimes Y$ and $Z$ given $A$. By the localized independence property (\Cref{local}), we then have that $f$ exhibits conditional independence of all $X$, $Y$ and $Z$ given $A$, and so, again by \Cref{indepkleisli}, $f^\sharp$ factors through the product $TX\times TY\times TZ$. 
 More specifically, by marginalizing over $Z$, we have that $g_{12}^\sharp$ factors through $TX\times TY$, i.e.~the following diagram on the left commutes for some $h_1^\sharp:A\to TX$ and $h_2^\sharp:A\to TY$, and similarly, by marginalizing over $X$, the diagram on the right commutes for some $\ell_2^\sharp:A\to TY$ and $\ell_3^\sharp:A\to TZ$.
 \[
  \begin{tikzcd}
   A \ar{d}[swap]{(h_1^\sharp,h_2^\sharp)} \ar{dr}{g_{12}^\sharp} \\
   TX\times TY \ar{r}[swap]{c} & T(X\times Y) 
  \end{tikzcd}
  \qquad
  \begin{tikzcd}
   A \ar{d}[swap]{(\ell_2^\sharp,\ell_3^\sharp)} \ar{dr}{g_{23}^\sharp} \\
   TY\times TZ \ar{r}[swap]{c} & T(Y\times Z) 
  \end{tikzcd}
 \]
 In other words, the upper and the left curved triangles in the following diagram commute.
\[
  \begin{tikzcd}[column sep=3.3pc]
   A \ar[bend left=15, shift left]{drr}{(g_1^\sharp,g_{23}^\sharp)} \ar[bend right=35]{ddr}[swap]{(g_{12}^\sharp,g_3^\sharp)} 
    \ar[shift left]{dr}[near end]{(g_1^\sharp,\ell_2^\sharp,\ell_3^\sharp)} \ar[shift right]{dr}[swap, pos=0.7]{(h_1^\sharp,h_2^\sharp, g_3^\sharp)} \\
   & T(X) \times T(Y) \times T(Z) \ar{r}[swap]{\id \times c_{Y,Z}} \ar{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
   & T(X \times Y) \times T(Z) \ar{r}[swap]{c_{X\times Y,Z}}						& T(X \times Y \times Z)
  \end{tikzcd}
 \]
 By marginalizing over $Y$ and $Z$, and by weak affinity of $T$, there exists a unique $a^\sharp:A\to T1$ such that $h_1 = a\cdot g_1$. 
 Therefore
 \[
  g_{12} = h_1\cdot h_2 = (a\cdot g_1) \cdot h_2 = g_1\cdot (a\cdot h_2) ,
 \]
 and so in the diagram above we can equivalently replace $h_1$ and $h_2$ with $g_1$ and $a\cdot h_2$.
 Similarly by marginalizing over $X$ and $Y$, there exists a unique $c^\sharp:A\to T1$ such that $\ell_3=c\cdot g_3$, so that
 \[
  g_{23}= \ell_2\cdot\ell_3 = \ell_2\cdot (c\cdot g_3) = (c\cdot \ell_2) \cdot g_3
 \]
 and in the diagram above we can replace $\ell_2$ and $\ell_3$ with $c\cdot \ell_2$ and $g_3$, as follows.
 \[
  \begin{tikzcd}[column sep=3.3pc]
   A \ar[bend left=15, shift left]{drrr}{(g_1^\sharp,g_{23}^\sharp)} \ar[bend right=35]{ddrr}[swap]{(g_{12}^\sharp,g_3^\sharp)} 
    \ar[shift left]{drr}[near end]{(g_1^\sharp,(c\cdot\ell_2)^\sharp,g_3^\sharp)} \ar[shift right]{drr}[swap, pos=0.8]{(g_1^\sharp,(a\cdot h_2)^\sharp, g_3^\sharp)} \\
   && T(X) \times T(Y) \times T(Z) \ar{r}[swap]{\id \times c_{Y,Z}} \ar{d}{c_{X,Y} \times \id}	& T(X) \times T(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
   && T(X \times Y) \times T(Z) \ar{r}[swap]{c_{X\times Y,Z}}						& T(X \times Y \times Z)
  \end{tikzcd}
 \]
 Now, marginalizing over $X$ and $Z$, we see that necessarily $a\cdot h_2=c\cdot \ell_2$. 
 Therefore there is a unique map $A\to TX\times TY\times TZ$ making the whole diagram commute, which means that \eqref{assoc_pullback} is a pullback.
 
 $\ref{condpullback}\Rightarrow\ref{condgroup}$:
 If $T$ is weakly affine, then taking $X = Y = Z = 1$ in~\eqref{assoc_pullback} shows that this monoid must be an abelian group: we obtain a unique arrow $\freccia{T(1)}{\iota}{T(1)}$ making the following diagram commute,
	\[
		\begin{tikzcd}
			T1 \ar{dr}[description]{(\id,\iota,\id)} \ar[bend left=15]{drr}{(\id,\eta_1 !)} \ar[bend right,swap]{ddr}{(\eta_1 !,\id)} \\
			&	T1 \times T1 \times T1 \ar{r}{\id \times c_{1,1}} \ar[swap]{d}{c_{1,1} \times \id}	& T1 \times T(1\times 1) \ar{d}{c_{1,1\times 1}} \ar{r}{\cong} & T1\times T1 \ar{d}{c_{1,1}}	\\
			&	T(1\times 1) \times T1 \ar{r}{c_{1\times 1,1}} \ar{d}[swap]{\cong}	& T(1\times 1\times 1) \ar{d}{\cong} \ar{r}{\cong} & T(1\times 1) \ar{d}{\cong} \\
			& T1\times T1 \ar{r}[swap]{c_{1,1}} & T(1\times 1) \ar{r}[swap]{\cong} & T1
		\end{tikzcd}
	\]
	and the commutativity shows that $\iota$ satisfies the equations making it the inversion map for a group structure.
\end{proof}


\begin{myexample}
 In the Kleisli category of the measure monad $\mathrm{Kl}_M$ (which is not weakly affine) consider the following diagram.
 \[
		\hspace{-9pt}	% T: for centering the equation number
		\begin{tikzcd}[column sep=3.3pc]
			MX \times MY \times MZ \ar{r}{\id \times c_{Y,Z}} \ar[swap]{d}{c_{X,Y} \times \id}	& MX \times M(Y \times Z) \ar{d}{c_{X,Y \times Z}}	\\
			M(X \times Y) \times MZ \ar{r}{c_{X\times Y,Z}}						& M(X \times Y \times Z)
		\end{tikzcd}
	\]
	In the top-right corner $MX\times M(Y\times Z)$, take the pair $(0,p)$ where $p$ is a nonzero measure on $Y\times Z$, and similarly, in the bottom-left corner take the pair $(q,0)$ where $q$ is a nonzero measure on $X\times Y$. Following the diagram, both pairs are mapped to the zero measure in the bottom-right corner. If the diagram was a pullback, we would be able to express the top-right and bottom-left corners as coming from the same triple in $MX\times MY\times MZ$, that is, there would exist a measure $m$ on $Y$ such that $m\cdot 0=p$ and $0\cdot m=q$. Since $p$ and $q$ are nonzero, this is not possible.
\end{myexample}



\section{Further results}


\begin{myproposition}
Let $T$ be a weakly affine monad. If the diagram
% https://q.uiver.app/?q=WzAsNCxbMCwwLCJUKDEpIl0sWzAsMSwiVCgxKSJdLFsxLDEsIlReMigxKSJdLFsxLDAsIlQoMSkiXSxbMCwxLCJcXGlvdGEiLDJdLFsxLDIsIlQoXFxldGFfMSkiLDJdLFswLDNdLFszLDIsIlxcZXRhX3tUMX0iXV0=
\[\begin{tikzcd}
	{T(1)} & {T(1)} \\
	{T(1)} & {T^2(1)}
	\arrow["\iota"', from=1-1, to=2-1]
	\arrow["{T(\eta_1)}"', from=2-1, to=2-2]
	\arrow["\id",from=1-1, to=1-2]
	\arrow["{\eta_{T1}}", from=1-2, to=2-2]
\end{tikzcd}\]
commutes, then:
\begin{enumerate}
	\item $T^2(1)\cong T(1)$ in $\mD$. 
	\item the internal group $T(1)$ has exponent $2$, namely $\iota=\id_{T1}$;
	\item the group $\mathrm{Kl}_T(X,1)$ has exponent $2$.
\end{enumerate}
\end{myproposition}

\todo[inline]{T: Having a nontrivial example of this statement would help to motivate and illustrate it. Like this, its meaning and significance remains quite unclear}

\begin{proof}
	To prove the first claim, it is enough to show that $T(1)\cong 1$ in the Kleisli category $\mathrm{Kl}_T$.
	By weak affinity, $T(1)$ is a group in $\mD$, where the arrow $\freccia{1}{\eta_1}{T(1)}$ is the unit of the group and $\freccia{T(1)}{\iota}{T(1)}$ is the inversion map. Therefore, we have that the composition $\freccia{1}{\iota\eta_1}{T(1)}$ has to be equal to $\eta_1$.
	Hence we can consider the arrows $1\to T(1)$ and $T(1)\to 1$ in the Kleisli category $\mathrm{Kl}_T$ represented by $T(\eta_1)\eta_1$ and $\iota$, respectively. The composition $T(\eta_1)\eta_1$ with $\iota$ in $\mathrm{Kl}_T$ is given by $\mu_{1,1}T(\iota)T(\eta_1)\eta_1$. Employing the naturality of $\eta_1$ and the fact that $\iota\eta_1=\eta_1$, it is direct to check that $\mu T(\iota)T(\eta_1)\eta_1=\eta_1$, that is the identity $1\to 1$ in $\mathrm{Kl}_T$. Now to show that the other composition gives the identity on $T(1)$ in $\mathrm{Kl}_T$, it is enough to show that $T(\eta_1)\iota=\eta_{T(1)}$, but this follows by hypothesis.

	For the second claim, we can compose the diagram with the monad multiplication, obtaining $\iota=\id_{T1}$.
	
	The last claim follows by combining the second one with the explicit construction of inverses in $\mathrm{Kl}_T(X,1)$ (see the proof of \Cref{weaklyboth}).
\end{proof}


\begin{myremark}
 Bart Jacobs calls a strong monad $T$ on a cartesian monoidal category \emph{strongly affine}~\cite{Jacobs16} if for every pair of objects $X$ and $Y$, the following diagram is a pullback,
 \[
  \begin{tikzcd}
   X \times TY \ar{d}{\pi_1} \ar{r}{s} & T(X\times Y) \ar{d}{T\pi_1} \\
   X \ar{r}{\eta} & TX
  \end{tikzcd}
 \]
where $s$ denotes the strength and $\eta$ denotes the unit of the monad. Every strongly affine monad is affine. 
The corresponding condition on the (Markov) category $\mathrm{Kl}_T$ is called \emph{positivity}~\cite[Section~2]{fritz2022dilations}.

Note that for a generic commutative monad, the diagram above may even fail to commute (take for example the measure monad $M$, and start with $(x,0)$ in the top left corner). One can however consider the following diagram, which reduces to the one above (up to isomorphism) in the affine case,
\[
 \begin{tikzcd}
   X \times TY \ar{d}{\id\times T!} \ar{r}{s} & T(X\times Y) \ar{d}{T(\id\times!)} \\
   X \times T1 \ar{r}{s} & T(X\times 1) \cong TX
  \end{tikzcd}
\]
and which always commutes by naturality of the strength.
\todo[inline]{T: Oh yes! Now Bart's diagram makes a lot more sense}
One can then call the monad $T$ \emph{positive} if this second diagram is a pullback (and possibly define \emph{positive gs-monoidal categories} analogously to positive Markov categories). 
All the examples of weakly affine monads that we have are positive in this sense, so one may wonder if every weakly affine monad is positive. For now, this remains an open question.
\todo[inline]{T: Isn't the answer clearly negative since we have affine monads that are not strongly affine?}
\todo[inline]{P: Good point. Okay, it was not clear to me :)}

\end{myremark}

\bibliography{biblio_davide}


\appendix

\section{Yoneda embedding interpretation of \Cref{weaklyboth}}\label{yoneda}

We can interpret \Cref{weaklyboth} more abstractly in terms of presheaves.
Let $\mD$ be a cartesian monoidal category.
Consider the presheaf category $[\mD^\mathrm{op},\Set]$, equipped with the Day convolution product,
\[
 F\boxtimes G \cong \int^{A,B\in\mD} \mD(-, A\times B) \times F(A) \times G(B) .
\]
The Yoneda embedding $\mD\to [\mD^\mathrm{op},\Set]$ is strong monoidal: indeed, for each $X$,
\[
 1 \cong \mD(X,1) ,
\]
since $1$ is terminal, and for each $X$ and $Y$, by Yoneda reduction,
\begin{align*}
 \mD(-,X) \boxtimes \mD(-,Y) &\cong \int^{A,B\in\mD} \mD(-, A\times B) \times \mD(-,X) \times \mD(-,Y) \\
  &\cong \mD(-, X\times Y) .
\end{align*}
Therefore, and by the universal property of products, at the level of individual hom-sets the Day convolution product of representable presheaves just takes the cartesian products of sets: 
\[
 \big(\mD(-,X) \boxtimes \mD(-,Y)\big)(A) \cong  \mD(A, X\times Y) \cong \mD(A,X) \times \mD(A,Y) .
\]
Take now an object $M$ of $\mD$. Since the Yoneda embedding is fully faithful and strong monoidal, a monoid structure $(M,m,e)$ on $M$ is equivalently a monoid structure on the representable presheaf $\mD(-,M)$. 
This makes the individual hom-sets monoids, with unit and multiplication as follows for each object $X$:
\[
 \begin{tikzcd}[row sep=tiny]
  1 \ar{r}{\cong} & \mD(X,1) \ar{r}{e_*} & \mD(X,M) \\
  \mD(X,M) \times \mD(X,M) \ar{r}{\cong} & \mD(X,M\times M) \ar{r}{m_*} & \mD(X,M) 
 \end{tikzcd}
\]
\todo[inline]{T: Using this doesn't require Day convolution though, so perhaps we can get rid of that to simplify?}
This is precisely the monoid structure that we have defined in \Cref{monoids} for $M=T1$. 

\begin{myproposition}
 $M$ is an internal group if and only if all the monoids $\mD(X,M)$ are groups.
\end{myproposition}
\begin{proof}
 By \Cref{assoc_group}, $M$ is a group object if and only if its associativity square \eqref{assoc} is a pullback. Since the hom-functor preserves and reflects all limits in its second argument, we have that \eqref{assoc} is a pullback if and only if for each object $X$, the following diagram (or equivalently, its bottom right square) is a pullback,
 \[
  \begin{tikzcd}[column sep=small]
  \mD(X,M) \times \mD(X,M) \times \mD(X,M) \ar{dr}[swap]{\cong} \ar{dd} \ar{rr} && \mD(X,M) \times \mD(X,M) \ar{d}{\cong} \\
  & \mD(X,M\times M\times M) \ar{r}[swap]{(m\times\id)_*} \ar{d}{(\id\times m)_*} & \mD(X,M\times M) \ar{d}{m_*} \\
  \mD(X,M) \times \mD(X,M) \ar{r}[swap]{\cong} & \mD(X,M\times M) \ar{r}[swap]{m_*} & \mD(X,M)
  \end{tikzcd}
 \]
 where the unlabelled arrows are the unique ones that make the diagram commute.
 Again by \Cref{assoc_group}, the diagram above is a pullback if and only if $\mD(X,M)$ is a group.
\end{proof}


\end{document}


